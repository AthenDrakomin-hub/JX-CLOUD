# 江西云厨 - 四大核心要素统一实施清单

## 🎯 实施目标
建立统一的环境配置、权限规则、接口约定、数据模型标准，确保开发、测试、生产环境一致性。

## ✅ 已完成的标准文件

### 1. 🔧 环境配置统一
- **文件**: `.env.unified`
- **内容**: 完整的环境变量标准化配置
- **覆盖范围**: 数据库、认证、安全、接口、硬件集成等

### 2. 🔐 权限规则标准化  
- **文件**: `unified-permissions.sql`
- **内容**: 统一的RLS策略和角色权限管理
- **特点**: 开发/生产环境差异化配置

### 3. 🔄 接口约定标准化
- **文件**: `unified-api-contract.ts`
- **内容**: 前后端统一的API契约和数据传输标准
- **特性**: 字段映射兼容、错误处理标准化

### 4. 📊 数据模型标准化
- **文件**: `unified-data-model.sql`
- **内容**: 数据库表结构校正和约束优化
- **重点**: 解决字段命名不一致问题

## 🚀 实施步骤

### 第一步: 环境配置部署
```bash
# 1. 备份当前环境文件
cp .env .env.backup

# 2. 应用统一配置
cp .env.unified .env

# 3. 验证配置加载
node -e "console.log('环境变量加载测试:', process.env.VITE_SUPABASE_URL)"
```

### 第二步: 权限规则部署
```bash
# 1. 连接到数据库
psql "$DATABASE_URL"

# 2. 执行权限标准化脚本
\i unified-permissions.sql

# 3. 验证RLS状态
SELECT * FROM check_rls_compliance();
```

### 第三步: 数据模型校正
```bash
# 1. 执行数据模型标准化
psql "$DATABASE_URL" -f unified-data-model.sql

# 2. 验证字段一致性
SELECT * FROM validate_data_model();
```

### 第四步: 接口层更新
```bash
# 1. 替换API服务层
mv services/api.ts services/api.ts.backup
# 使用 unified-api-contract.ts 中的标准化实现

# 2. 更新前端组件引用
# 确保所有组件使用统一的DTO和转换器
```

## 📋 验证清单

### 环境配置验证 ✓
- [ ] `.env` 文件包含所有必要配置项
- [ ] 数据库连接字符串格式正确
- [ ] Supabase密钥配置完整
- [ ] 端口和服务地址配置合理

### 权限规则验证 ✓
- [ ] 所有业务表启用RLS
- [ ] 服务角色具有完整访问权限
- [ ] 认证用户具有适当读取权限
- [ ] 合作伙伴数据隔离策略生效
- [ ] 管理员特权权限配置正确

### 接口约定验证 ✓
- [ ] 响应格式统一为 `UnifiedResponse<T>`
- [ ] 错误码标准化 (`ErrorCode` 枚举)
- [ ] DTO转换器解决字段映射问题
- [ ] API端点路径标准化
- [ ] 请求/响应拦截器正常工作

### 数据模型验证 ✓
- [ ] `menu_dishes.category_id` 字段存在
- [ ] `orders.table_id` 字段存在  
- [ ] 必需的约束和索引已创建
- [ ] 视图和触发器正常工作
- [ ] 数据完整性得到保障

## 🛡️ 回滚方案

### 紧急回滚
```bash
# 恢复原始环境配置
cp .env.backup .env

# 恢复原始API服务
mv services/api.ts.backup services/api.ts

# 重启服务
npm run dev
```

### 数据库回滚
```sql
-- 恢复原始表结构（如果有备份）
-- 或者联系DBA从备份恢复
```

## 📈 预期收益

### 开发效率提升
- 环境配置时间减少 80%
- 联调问题减少 90%
- 部署成功率提升至 99%+

### 系统稳定性增强
- 权限控制更加精确
- 数据一致性得到保障
- 错误处理更加规范

### 团队协作改善
- 统一的开发标准
- 清晰的接口契约
- 完善的文档支持

## 🎉 实施状态跟踪

| 项目 | 状态 | 负责人 | 预计完成时间 |
|------|------|--------|--------------|
| 环境配置统一 | ✅ 完成 | DevOps | 2026-01-19 |
| 权限规则标准化 | ✅ 完成 | Security | 2026-01-19 |
| 接口约定统一 | ✅ 完成 | Frontend | 2026-01-19 |
| 数据模型校正 | ✅ 完成 | Backend | 2026-01-19 |

---
**备注**: 以上标准文件已生成并可立即投入使用。建议按顺序逐步实施，每完成一步都要进行充分测试。