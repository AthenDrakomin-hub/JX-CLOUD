# 故障排查指南

## 常见错误代码含义

### 前端错误

#### HTTP错误
- **401 Unauthorized**: 认证失败，检查登录状态
- **403 Forbidden**: 权限不足，检查用户权限
- **404 Not Found**: 资源不存在，检查API端点
- **500 Internal Server Error**: 服务器错误，联系技术支持
- **502 Bad Gateway**: 网关错误，检查网络连接
- **503 Service Unavailable**: 服务不可用，稍后重试

#### JavaScript错误
- **Network Error**: 网络连接失败，检查网络状态
- **TypeError**: 类型错误，检查数据格式
- **ReferenceError**: 引用错误，检查变量声明
- **SyntaxError**: 语法错误，检查代码语法

### 后端错误

#### Supabase相关错误
- **PGRST101**: 连接池耗尽，检查数据库连接
- **PGRST116**: 查询超时，优化查询语句
- **PGRST301**: 认证失败，检查JWT令牌
- **RLS001**: RLS策略拒绝，检查权限设置

#### 数据库错误
- **23505**: 唯一约束违反，检查重复数据
- **23503**: 外键约束违反，检查关联数据
- **42601**: 语法错误，检查SQL语句
- **42P01**: 表不存在，检查表名

## 系统日志分析方法

### 前端日志分析

#### 日志位置
- 浏览器控制台 (F12)
- 应用程序日志
- 网络请求日志

#### 日志格式
```
[时间戳] [错误级别] [组件名] [错误信息] [堆栈跟踪]
```

#### 分析步骤
1. **识别错误类型**: 根据错误信息判断问题性质
2. **定位问题组件**: 通过组件名找到相关代码
3. **查看上下文**: 检查错误发生前的操作
4. **复现问题**: 按照日志中的操作路径复现

### 后端日志分析

#### Supabase日志
1. 登录Supabase控制台
2. 进入Project Settings -> Logs
3. 选择相应的时间范围
4. 过滤错误级别日志

#### 日志分析要点
- **时间戳**: 确定问题发生时间
- **错误代码**: 识别错误类型
- **用户ID**: 确定受影响用户
- **操作类型**: 了解错误操作
- **影响范围**: 评估问题严重性

### 安全日志分析

#### 安全事件分类
- **登录尝试**: 成功/失败的登录
- **权限变更**: 用户权限修改
- **数据访问**: 敏感数据访问
- **配置变更**: 系统配置修改

## 问题诊断流程

### 1. 问题识别
- 确认问题现象
- 收集用户反馈
- 复现问题场景
- 记录错误信息

### 2. 影响评估
- 确定受影响用户
- 评估业务影响
- 判断问题严重性
- 确定优先级

### 3. 根因分析
- 检查系统日志
- 分析错误模式
- 检查系统配置
- 验证数据一致性

### 4. 解决方案制定
- 确定修复方案
- 评估修复风险
- 制定回滚计划
- 准备修复代码

## 常见故障场景及解决方案

### 场景1: 系统无法访问
**症状**: 用户无法登录或访问系统
**排查步骤**:
1. 检查网络连接
2. 验证服务器状态
3. 检查域名解析
4. 验证SSL证书
5. 检查防火墙设置

**解决方案**:
- 检查服务器运行状态
- 重启相关服务
- 检查负载均衡配置
- 验证DNS设置

### 场景2: 数据同步异常
**症状**: 数据在不同设备间不同步
**排查步骤**:
1. 检查Supabase连接
2. 验证实时订阅设置
3. 检查网络连接质量
4. 验证权限配置

**解决方案**:
- 重启实时订阅
- 检查RLS策略
- 优化网络连接
- 手动同步数据

### 场景3: 订单处理失败
**症状**: 订单无法正常处理或状态更新失败
**排查步骤**:
1. 检查订单数据完整性
2. 验证数据库连接
3. 检查事务处理
4. 验证权限设置

**解决方案**:
- 修复数据完整性问题
- 重新处理失败订单
- 检查并发控制
- 验证业务逻辑

### 场景4: 性能下降
**症状**: 系统响应缓慢或超时
**排查步骤**:
1. 检查系统资源使用率
2. 分析慢查询
3. 验证缓存配置
4. 检查网络延迟

**解决方案**:
- 优化数据库查询
- 增加系统资源
- 优化缓存策略
- 调整负载均衡

## 应急恢复流程

### 1. 紧急响应
- **P0级故障**: 立即响应，通知相关团队
- **P1级故障**: 30分钟内响应
- **P2级故障**: 2小时内响应
- **P3级故障**: 24小时内响应

### 2. 故障处理
1. **隔离故障**: 防止问题扩散
2. **恢复服务**: 优先恢复核心功能
3. **根因修复**: 解决根本问题
4. **验证修复**: 确认问题已解决

### 3. 回滚计划
- **数据库回滚**: 使用备份恢复数据
- **代码回滚**: 部署上一个稳定版本
- **配置回滚**: 恢复之前的配置
- **服务回滚**: 重启服务到正常状态

## 预防措施

### 1. 监控预警
- 设置关键指标监控
- 配置自动告警
- 定期检查监控系统
- 更新告警规则

### 2. 定期维护
- 数据库性能优化
- 系统安全更新
- 依赖库版本更新
- 备份验证

### 3. 文档更新
- 更新故障处理文档
- 记录解决方案
- 分享经验教训
- 完善应急流程

## 联系支持

### 技术支持
- 邮箱: support@jxcloud.com
- 电话: [技术支持电话]
- 工单系统: [工单系统链接]

### 紧急联系
- 运维值班: [紧急联系方式]
- 开发团队: [紧急联系方式]
- 业务负责人: [紧急联系方式]